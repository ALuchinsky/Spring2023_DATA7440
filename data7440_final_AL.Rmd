---
title: "DATA7440, Final Assignment"
author: "Aleksei Luchinsky"
date: "2023-04-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
train = FALSE
```


# Problem 1

```{r}
load("./data/external/apipop1.RData")
```

```{r}
str(apipop_train1)
```

## Part 1

### a) LASSO model

```{r message=FALSE, warning=FALSE}
library(glmnet)
```

Preparing train data

```{r}
X <- data.matrix(apipop_train1[,-1])
y <- apipop_train1$awards
```



```{r}
if(file.exists("./data/models/cv.lasso.model") & train == FALSE) {
  print("Loading cv.lasso.model")
  load("./data/models/cv.lasso.model")
} else {
  print("Training cv.lasso.model")
  set.seed(7440)
  cv.lasso.model <- cv.glmnet(X, y, alpha = 1, standardize = TRUE, nfolds = 5, family = "binomial")
  save(cv.lasso.model, file = "./data/models/cv.lasso.model")
}
```

```{r}
lasso.best.lambda <- cv.lasso.model$lambda.min
plot(cv.lasso.model, main = round(lasso.best.lambda, 5))
```

```{r}
lasso.best.model <- glmnet(X, y, alpha = 1, lambda = lasso.best.lambda, family = "binomial")
```




```{r}
preds <- (predict(lasso.best.model, X, type = "response") > 0.56)
y_true = y=="Yes"
sum(y_true == preds)/length(y)
```

### b) OneR

```{r}
#install.packages("OneR")
library(OneR)
```



```{r}
if( file.exists("./data/models/oneR.model") & train == FALSE) {
  print("Loading oneR.model")
  load("./data/models/oneR.model")
} else {
  print("Training oneR.model")
  oneR.model <- OneR(awards ~ ., data = apipop_train1 )
  save(oneR.model, file = "./data/models/oneR.model")
}
```



```{r}
oneR.test.predicts <- predict(oneR.model, apipop_test1)
sum(oneR.test.predicts == apipop_test1$awards)/length(apipop_test1$awards)
```

### c) Sequential covering

```{r message=FALSE, warning=FALSE}
#install.packages("RWeka")
library(RWeka)
```


```{r}
# train <- FALSE
# if(file.exists("./data/models/seq.model") & train == FALSE) {
#   print("Loading seq.model")
#   load("./data/models/seq.model")
# } else {
  print("Training seq.model")
  seq.model <- JRip(awards ~ ., data = apipop_test1)
  # save(seq.model, file = "./data/models/seq.model")
# }
```

```{r}
seq.model
```

```{r}
sum(predict(seq.model, newdata = apipop_test1) == apipop_test1$awards)/nrow(apipop_test1)
```

### d) rule-fit

```{r message=FALSE, warning=FALSE}
#install.packages("pre")
library(pre)
```



```{r}
if(file.exists("./data/models/rule.fit.model") & train == FALSE) {
  print("Loading rule.fit.model")
  load("./data/models/rule.fit.model")
} else {
  print("Training rule.fit.model")
  set.seed(2021)
  rule.fit.model <- pre(awards ~ ., data = apipop_train1, family = "binomial", nfolds = 5)
  save(rule.fit.model, file = "./data/models/rule.fit.model")
}
```

```{r}
rule.fit.model
```


```{r}
sum(
  predict(rule.fit.model, newdata = apipop_test1, type = "response")>0.5
)/nrow(apipop_test1)
```

```{r}
rule.fit.imps <- importance(rule.fit.model)
```

## Part 2

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(caret)
```

```{r}
y.test <- apipop_test1$awards
```

```{r}
cm.table <- data.frame()
```


### LASSO model

```{r}
lasso.test.preds <- as.factor(as.vector(
  ifelse(predict(lasso.best.model, newx = data.matrix(apipop_test1[,-1]), type = "response") > 0.5, "Yes", "No")
))
cm <- confusionMatrix(lasso.test.preds, y.test)
cm.table <- rbind(cm.table, data.frame(model="LASSO", accuracy = cm$overall[1], kappa = cm$overall[2]))
```

### OneR

```{r}
oneR.test.preds <- as.factor(predict(oneR.model, apipop_test1))
cm <- confusionMatrix(oneR.test.preds, y.test)
cm.table <- rbind(cm.table, data.frame(model="OneR", accuracy = cm$overall[1], kappa = cm$overall[2]))
```

### Sequential model

```{r}
seq.test.preds <- as.factor(predict(seq.model, newdata = apipop_test1))
cm <- confusionMatrix(seq.test.preds, y.test)
cm.table <- rbind(cm.table, data.frame(model="SeqCover", accuracy = cm$overall[1], kappa = cm$overall[2]))
```

### Rule Fit

```{r}
rule.fit.test.preds <- as.factor(as.vector(
  ifelse(predict(rule.fit.model, newdata = apipop_test1, type = "response") > 0.5, "Yes", "No")
))
cm <- confusionMatrix(rule.fit.test.preds, y.test)
cm.table <- rbind(cm.table, data.frame(model="RuleFit", accuracy = cm$overall[1], kappa = cm$overall[2]))
```

```{r}
cm.table
```

## Part 3:


### LASSO


```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(dplyr)
library(magrittr)
library(ggplot2)
```


```{r}
lasso.imps <- lasso.best.model %>% coef %>% as.matrix %>% as.data.frame %>% 
  slice(-1) %>% abs %>% arrange(desc(s0))
head(lasso.imps)
```

### One R

```{r}
oneR.model
```

As you can see, only **stype** variable is important in oneR model

### Sequential Covering

Here is the list of the rules


```{r}
seq.model
```

I can convert it to string and try to extract the rules usin regex

```{r}
seq.model$classifier$toString()
```

Will do it later

### Rule Fit

```{r}
rule.fit.imps <- importance(rule.fit.model, plot = FALSE)
rule.fit.imps$varimps[1:4, ]
```

## Part 4

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(randomForest)
```


```{r}
if(file.exists("./data/models/rf.model") & train == FALSE) {
  print("Loading rf.model")
  load("./data/models/rf.model")
} else {
  print("Training rf.model")
  set.seed(429)
  rf.model <- randomForest(awards ~ ., data = apipop_train1, ntree = 750)
  save(rf.model, file = "./data/models/rf.model")
}
```

Train accuracy

```{r}
sum(predict(rf.model, newdata = apipop_train1) == apipop_train1$awards)/nrow(apipop_train1)
```

Test accuracy

```{r}
sum(predict(rf.model, newdata = apipop_test1) == apipop_test1$awards)/nrow(apipop_test1)
```

